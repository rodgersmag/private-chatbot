#!/bin/bash
# Unified Start Script - Starts Ollama + SelfDB together

# Check if first argument is "rebuild-ui"
if [ "$1" = "rebuild-ui" ]; then
    echo "ğŸ”¨ Rebuilding UI Docker containers..."
    echo ""

    echo "ğŸ“¦ Rebuilding Ollama UI service..."
    docker-compose build ui

    echo "ğŸ“¦ Rebuilding SelfDB frontend service..."
    docker-compose build frontend

    echo ""
    echo "ğŸš€ Restarting UI services..."
    docker-compose up -d ui frontend

    echo ""
    echo "âœ… UI containers rebuilt and restarted successfully!"
    echo "ğŸŒ Ollama UI: http://localhost:3050"
    echo "ğŸŒ SelfDB UI: http://localhost:3000"
    exit 0
fi

# Check if first argument is "rebuild-backend"
if [ "$1" = "rebuild-backend" ]; then
    echo "ğŸ”¨ Rebuilding backend services..."
    echo ""

    echo "ğŸ“¦ Rebuilding SelfDB backend services..."
    docker-compose build backend storage_service

    echo ""
    echo "ğŸš€ Restarting backend services..."
    docker-compose up -d backend storage_service

    echo ""
    echo "âœ… Backend services rebuilt and restarted successfully!"
    exit 0
fi

echo "ğŸš€ Setting up Ollama + SelfDB with unified configuration..."
echo ""

# Stop any running containers
echo "ğŸ›‘ Stopping any existing containers..."
docker-compose down 2>/dev/null || true

# Setup SelfDB environment and keys
echo "ğŸ”§ Setting up SelfDB environment..."
./scripts/generate_anon_key.sh

# Generate SECRET_KEY if it's still the default value
echo "ğŸ”‘ Checking SECRET_KEY..."
if [ -f ".env" ]; then
    # Extract current SECRET_KEY value (ignoring comments)
    CURRENT_SECRET_KEY=$(grep "^SECRET_KEY=" ".env" | cut -d '=' -f2 | cut -d '#' -f1 | tr -d ' ')

    # Check if it's still the default value
    if [ "$CURRENT_SECRET_KEY" = "changeme_super_secret_jwt_key_32_bytes_long" ] || [ -z "$CURRENT_SECRET_KEY" ]; then
        echo "ğŸ”„ Generating new SECRET_KEY..."
        # Generate a new 32-byte secret key
        NEW_SECRET_KEY=$(openssl rand -hex 32)

        # Replace the SECRET_KEY line in .env file, preserving the comment
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS version
            sed -i '' "s/^SECRET_KEY=.*/SECRET_KEY=$NEW_SECRET_KEY # <-- Will be auto-generated by start.sh/" ".env"
        else
            # Linux version
            sed -i "s/^SECRET_KEY=.*/SECRET_KEY=$NEW_SECRET_KEY # <-- Will be auto-generated by start.sh/" ".env"
        fi
        echo "âœ… New SECRET_KEY generated successfully"
    else
        echo "âœ… SECRET_KEY already configured"
    fi
else
    echo "âŒ Error: .env file not found"
    exit 1
fi

# Synchronize ANON_KEY with the backend
echo "ğŸ”— Synchronizing ANON_KEY with the backend..."
# Check if ANON_KEY exists in .env file
if [ ! -f ".env" ]; then
    echo "âŒ Error: .env file not found. Please run scripts/generate_anon_key.sh first."
    exit 1
fi

ANON_KEY_CHECK=$(grep "^ANON_KEY=" ".env" | cut -d '=' -f2)
if [ -z "$ANON_KEY_CHECK" ]; then
    echo "âŒ Error: ANON_KEY not found in .env file. Please run scripts/generate_anon_key.sh first."
    exit 1
fi

echo "âœ… Found ANON_KEY in .env file: ${ANON_KEY_CHECK:0:5}..."
echo "âœ… ANON_KEY is now synchronized with the backend."

# Source environment variables from .env
source .env

echo ""
echo "ğŸ“¦ Starting all services..."
docker-compose up -d

echo ""
echo "â³ Waiting for Ollama server to be ready..."
# Wait for Ollama to be healthy
for i in {1..30}; do
    if docker-compose exec -T ollama ollama list >/dev/null 2>&1; then
        echo "âœ… Ollama server is ready!"
        break
    fi
    echo -n "."
    sleep 2
done

echo ""
echo "ğŸ“¥ Checking if model ${VITE_DEFAULT_MODEL} is available..."
# Check if model exists
if docker-compose exec -T ollama ollama list | grep -q "${VITE_DEFAULT_MODEL}"; then
    echo "âœ… Model ${VITE_DEFAULT_MODEL} already cached!"
else
    echo "ğŸ“¦ Model not found. Downloading ${VITE_DEFAULT_MODEL} (this may take 2-5 minutes on first run)..."
    docker-compose exec -T ollama ollama pull ${VITE_DEFAULT_MODEL}
    echo "âœ… Model downloaded successfully!"
fi

echo ""
echo "ğŸ“Š Available models:"
docker-compose exec -T ollama ollama list

echo ""
echo "â³ Waiting for SelfDB services to be ready..."
echo "   - Checking PostgreSQL..."
docker-compose exec -T postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} >/dev/null 2>&1 && echo "âœ… PostgreSQL ready" || echo "â³ PostgreSQL starting..."

echo "   - Checking Storage Service..."
for i in {1..20}; do
    if curl -f http://localhost:8001/health >/dev/null 2>&1; then
        echo "âœ… Storage Service ready"
        break
    fi
    echo -n "."
    sleep 2
done

echo "   - Checking Backend API..."
for i in {1..30}; do
    if curl -f http://localhost:8000/docs >/dev/null 2>&1; then
        echo "âœ… Backend API ready"
        break
    fi
    echo -n "."
    sleep 2
done

echo ""
echo "ğŸ”§ Initializing chat tables..."
./scripts/init_chat_tables.sh

echo ""
echo "âœ¨ All services are now running!"
echo ""
echo "ğŸŒ Service URLs:"
echo "   ğŸ“± Ollama UI:     http://localhost:3050"
echo "   ğŸ—„ï¸  SelfDB UI:     http://localhost:3000"
echo "   ğŸ”Œ Ollama API:    http://localhost:11434"
echo "   ğŸš€ SelfDB API:    http://localhost:8000"
echo "   ğŸ’¾ Storage API:   http://localhost:8001"
echo "   âš¡ Functions:     http://localhost:8090"
echo ""
echo "ğŸ¯ You can now use main.py to interact with the Ollama API:"
echo "   python3 main.py"
echo ""
echo "ğŸ’¡ Next time you run './start-all.sh' it will start in just 10-20 seconds!"
echo ""
echo "ğŸ”§ Additional commands:"
echo "   ./start-all.sh rebuild-ui      # Rebuild UI containers"
echo "   ./start-all.sh rebuild-backend # Rebuild backend containers"
echo "   ./stop-all.sh                  # Stop all services"
echo "   ./rebuild-all.sh               # Rebuild all services"
echo "   ./cleanup-all.sh               # Clean up everything (âš ï¸  DELETES DATA)"
echo "   ./test-selfdb.sh               # Run SelfDB test suite"
echo "   docker-compose logs -f         # View all logs"
echo "   docker-compose down            # Stop all services"